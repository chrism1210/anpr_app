{% extends "base.html" %}

{% block title %}Hotlists - ANPR System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-list me-2"></i>
                Vehicle Hotlists
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#hotlistGroupModal">
                <i class="fas fa-plus me-2"></i>
                Add Hotlist Group
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Search license plates, descriptions, or categories...">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="categoryFilter">
            <option value="">All Categories</option>
            <option value="stolen">Stolen</option>
            <option value="wanted">Wanted</option>
            <option value="bolo">BOLO</option>
            <option value="suspicious">Suspicious</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Hotlist Name</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Description</th>
                        <th>Vehicles</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="hotlistsTable">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Hotlist Group Modal -->
<div class="modal fade" id="hotlistGroupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Hotlist Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="hotlistGroupForm">
                    <!-- Hotlist Group Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hotlistName" class="form-label">Hotlist Name *</label>
                                <input type="text" class="form-control" id="hotlistName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category *</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="stolen">Stolen</option>
                                    <option value="wanted">Wanted</option>
                                    <option value="bolo">BOLO</option>
                                    <option value="suspicious">Suspicious</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createdBy" class="form-label">Created By *</label>
                                <input type="text" class="form-control" id="createdBy" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    

                    
                    <hr>
                    
                    <!-- Vehicles Section -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Vehicles in this Hotlist</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addVehicleBtn">
                            <i class="fas fa-plus me-1"></i>
                            Add Vehicle
                        </button>
                    </div>
                    
                    <div id="vehiclesContainer">
                        <!-- Vehicle entries will be added here -->
                    </div>
                    

                    

                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expiryDate" class="form-label">Expiry Date</label>
                                <input type="datetime-local" class="form-control" id="expiryDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 form-check" style="margin-top: 2rem;">
                                <input type="checkbox" class="form-check-input" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn">Save Hotlist Group</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentHotlistGroupId = null;
let vehicleCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadHotlistGroups();
    
    // Search functionality
    document.getElementById('searchBtn').addEventListener('click', loadHotlistGroups);
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadHotlistGroups();
        }
    });
    
    // Filter functionality
    document.getElementById('categoryFilter').addEventListener('change', loadHotlistGroups);
    document.getElementById('statusFilter').addEventListener('change', loadHotlistGroups);
    
    // Form submission
    document.getElementById('saveBtn').addEventListener('click', saveHotlistGroup);
    
    // Add vehicle button
    document.getElementById('addVehicleBtn').addEventListener('click', addVehicleRow);
    
    // Reset form when modal closes
    document.getElementById('hotlistGroupModal').addEventListener('hidden.bs.modal', function () {
        resetHotlistGroupForm();
    });
    
    // Add initial vehicle row
    addVehicleRow();
});

async function loadHotlistGroups() {
    try {
        const search = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = '/api/hotlist-groups';
        const params = new URLSearchParams();
        
        if (search) params.append('search', search);
        if (params.toString()) url += '?' + params.toString();
        
        const response = await axios.get(url);
        let hotlistGroups = response.data;
        
        // Filter by category and status on frontend
        if (category) {
            hotlistGroups = hotlistGroups.filter(h => h.category === category);
        }
        if (status) {
            hotlistGroups = hotlistGroups.filter(h => status === 'active' ? h.is_active : !h.is_active);
        }
        
        const tableBody = document.getElementById('hotlistsTable');
        
        if (hotlistGroups.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hotlist groups found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = hotlistGroups.map(group => `
            <tr>
                <td><strong>${group.name}</strong></td>
                <td>
                    <span class="badge bg-${getCategoryColor(group.category)}">${group.category}</span>
                </td>
                <td>
                    <span class="badge bg-${getPriorityColor(group.priority)}">${group.priority}</span>
                </td>
                <td>${group.description}</td>
                <td>
                    <div class="d-flex flex-wrap gap-1">
                        ${group.vehicles.map(vehicle => `
                            <span class="badge bg-primary" title="${vehicle.vehicle_make || ''} ${vehicle.vehicle_model || ''} ${vehicle.vehicle_color || ''}">
                                ${vehicle.license_plate}
                            </span>
                        `).join('')}
                    </div>
                </td>
                <td>${formatDate(group.created_at)}</td>
                <td>
                    <span class="badge bg-${group.is_active ? 'success' : 'secondary'}">
                        ${group.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editHotlistGroup(${group.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteHotlistGroup(${group.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading hotlists:', error);
        showAlert('Error loading hotlists', 'danger');
    }
}

// Add vehicle row to the form
function addVehicleRow() {
    const container = document.getElementById('vehiclesContainer');
    const vehicleId = vehicleCounter++;
    
    const vehicleRow = document.createElement('div');
    vehicleRow.className = 'card mb-3';
    vehicleRow.id = `vehicle-${vehicleId}`;
    vehicleRow.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title mb-0">Vehicle ${vehicleId + 1}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVehicleRow(${vehicleId})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <!-- Tabbed Interface for ANPR-compliant fields -->
            <ul class="nav nav-tabs" id="vehicleTabs-${vehicleId}" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-tab-${vehicleId}" data-bs-toggle="tab" data-bs-target="#basic-${vehicleId}" type="button" role="tab">
                        Basic Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="technical-tab-${vehicleId}" data-bs-toggle="tab" data-bs-target="#technical-${vehicleId}" type="button" role="tab">
                        Technical Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="operational-tab-${vehicleId}" data-bs-toggle="tab" data-bs-target="#operational-${vehicleId}" type="button" role="tab">
                        ANPR Operational
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="intelligence-tab-${vehicleId}" data-bs-toggle="tab" data-bs-target="#intelligence-${vehicleId}" type="button" role="tab">
                        Intelligence
                    </button>
                </li>
            </ul>
            
            <div class="tab-content mt-3" id="vehicleTabContent-${vehicleId}">
                <!-- Basic Details Tab -->
                <div class="tab-pane fade show active" id="basic-${vehicleId}" role="tabpanel">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="licensePlate-${vehicleId}" class="form-label">License Plate (VRM) *</label>
                                <input type="text" class="form-control" id="licensePlate-${vehicleId}" name="licensePlate" required 
                                       placeholder="e.g. AB12 CDE">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="vehicleMake-${vehicleId}" class="form-label">Make</label>
                                <input type="text" class="form-control" id="vehicleMake-${vehicleId}" name="vehicleMake"
                                       placeholder="e.g. Ford, BMW, Toyota">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="vehicleModel-${vehicleId}" class="form-label">Model</label>
                                <input type="text" class="form-control" id="vehicleModel-${vehicleId}" name="vehicleModel"
                                       placeholder="e.g. Focus, X5, Corolla">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="vehicleColor-${vehicleId}" class="form-label">Color</label>
                                <input type="text" class="form-control" id="vehicleColor-${vehicleId}" name="vehicleColor"
                                       placeholder="e.g. Blue, Red, Silver">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="bodyType-${vehicleId}" class="form-label">Body Type</label>
                                <select class="form-select" id="bodyType-${vehicleId}" name="bodyType">
                                    <option value="">Select Body Type</option>
                                    <option value="Saloon">Saloon</option>
                                    <option value="Hatchback">Hatchback</option>
                                    <option value="Estate">Estate</option>
                                    <option value="SUV">SUV</option>
                                    <option value="Coupe">Coupe</option>
                                    <option value="Convertible">Convertible</option>
                                    <option value="MPV">MPV</option>
                                    <option value="Van">Van</option>
                                    <option value="Truck">Truck</option>
                                    <option value="Motorcycle">Motorcycle</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="fuelType-${vehicleId}" class="form-label">Fuel Type</label>
                                <select class="form-select" id="fuelType-${vehicleId}" name="fuelType">
                                    <option value="">Select Fuel Type</option>
                                    <option value="Petrol">Petrol</option>
                                    <option value="Diesel">Diesel</option>
                                    <option value="Electric">Electric</option>
                                    <option value="Hybrid">Hybrid</option>
                                    <option value="LPG">LPG</option>
                                    <option value="CNG">CNG</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="vehicleFeatures-${vehicleId}" class="form-label">Distinctive Features</label>
                                <input type="text" class="form-control" id="vehicleFeatures-${vehicleId}" name="vehicleFeatures"
                                       placeholder="e.g. Roof rack, tinted windows">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Technical Details Tab -->
                <div class="tab-pane fade" id="technical-${vehicleId}" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vinNumber-${vehicleId}" class="form-label">VIN Number</label>
                                <input type="text" class="form-control" id="vinNumber-${vehicleId}" name="vinNumber" 
                                       maxlength="17" placeholder="17-character VIN">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="engineNumber-${vehicleId}" class="form-label">Engine Number</label>
                                <input type="text" class="form-control" id="engineNumber-${vehicleId}" name="engineNumber">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="engineCapacity-${vehicleId}" class="form-label">Engine Capacity (cc)</label>
                                <input type="number" class="form-control" id="engineCapacity-${vehicleId}" name="engineCapacity" 
                                       min="0" placeholder="e.g. 1600">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dateOfFirstRegistration-${vehicleId}" class="form-label">Date of First Registration</label>
                                <input type="date" class="form-control" id="dateOfFirstRegistration-${vehicleId}" name="dateOfFirstRegistration">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dateOfFirstUkRegistration-${vehicleId}" class="form-label">Date of First UK Registration</label>
                                <input type="date" class="form-control" id="dateOfFirstUkRegistration-${vehicleId}" name="dateOfFirstUkRegistration">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="vehicleManufacturedDate-${vehicleId}" class="form-label">Manufacture Date</label>
                                <input type="date" class="form-control" id="vehicleManufacturedDate-${vehicleId}" name="vehicleManufacturedDate">
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="theftMarker-${vehicleId}" name="theftMarker">
                                        <label class="form-check-label" for="theftMarker-${vehicleId}">
                                            Theft Marker
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scrapMarker-${vehicleId}" name="scrapMarker">
                                        <label class="form-check-label" for="scrapMarker-${vehicleId}">
                                            Scrap Marker
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="exportMarker-${vehicleId}" name="exportMarker">
                                        <label class="form-check-label" for="exportMarker-${vehicleId}">
                                            Export Marker
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ANPR Operational Tab -->
                <div class="tab-pane fade" id="operational-${vehicleId}" role="tabpanel">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="warningMarkers-${vehicleId}" class="form-label">Warning Markers</label>
                                <input type="text" class="form-control" id="warningMarkers-${vehicleId}" name="warningMarkers"
                                       placeholder="e.g. FIREARMS, VIOLENT">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="nimCode-${vehicleId}" class="form-label">NIM (5x5x5) Code</label>
                                <input type="text" class="form-control" id="nimCode-${vehicleId}" name="nimCode"
                                       placeholder="e.g. 123/45/67">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="forceArea-${vehicleId}" class="form-label">Force/Area</label>
                                <input type="text" class="form-control" id="forceArea-${vehicleId}" name="forceArea"
                                       placeholder="e.g. Met Police, Thames Valley">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="weedDate-${vehicleId}" class="form-label">Weed Date</label>
                                <input type="date" class="form-control" id="weedDate-${vehicleId}" name="weedDate">
                                <div class="form-text">Date when record should be reviewed/removed</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="pncId-${vehicleId}" class="form-label">PNC ID</label>
                                <input type="text" class="form-control" id="pncId-${vehicleId}" name="pncId"
                                       placeholder="Police National Computer ID">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="gpmsMarking-${vehicleId}" class="form-label">GPMS Marking</label>
                                <select class="form-select" id="gpmsMarking-${vehicleId}" name="gpmsMarking">
                                    <option value="Unclassified">Unclassified</option>
                                    <option value="Official">Official</option>
                                    <option value="Official-Sensitive">Official-Sensitive</option>
                                    <option value="Secret">Secret</option>
                                    <option value="Top Secret">Top Secret</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cadInformation-${vehicleId}" class="form-label">CAD Information</label>
                                <input type="text" class="form-control" id="cadInformation-${vehicleId}" name="cadInformation"
                                       placeholder="Command and Control information">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reviewDate-${vehicleId}" class="form-label">Next Review Date</label>
                                <input type="date" class="form-control" id="reviewDate-${vehicleId}" name="reviewDate">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Intelligence Tab -->
                <div class="tab-pane fade" id="intelligence-${vehicleId}" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sourceReference-${vehicleId}" class="form-label">Source Reference</label>
                                <input type="text" class="form-control" id="sourceReference-${vehicleId}" name="sourceReference"
                                       placeholder="Intelligence source reference">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="authorizingOfficer-${vehicleId}" class="form-label">Authorizing Officer</label>
                                <input type="text" class="form-control" id="authorizingOfficer-${vehicleId}" name="authorizingOfficer"
                                       placeholder="Officer authorizing entry">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="intelligenceInformation-${vehicleId}" class="form-label">Intelligence Information</label>
                                <textarea class="form-control" id="intelligenceInformation-${vehicleId}" name="intelligenceInformation" 
                                         rows="3" placeholder="Detailed intelligence information about this vehicle"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="operationalInstructions-${vehicleId}" class="form-label">Operational Instructions</label>
                                <textarea class="form-control" id="operationalInstructions-${vehicleId}" name="operationalInstructions" 
                                         rows="3" placeholder="Specific operational instructions for officers"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legacy fields (marked as deprecated) -->
                    <hr>
                    <h6 class="text-muted">Legacy Fields (Deprecated)</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vehicleYear-${vehicleId}" class="form-label">Vehicle Year <small class="text-muted">(deprecated)</small></label>
                                <input type="number" class="form-control" id="vehicleYear-${vehicleId}" name="vehicleYear" 
                                       min="1900" max="2030" placeholder="Use registration date instead">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ownerName-${vehicleId}" class="form-label">Owner Name <small class="text-muted">(deprecated)</small></label>
                                <input type="text" class="form-control" id="ownerName-${vehicleId}" name="ownerName"
                                       placeholder="Use intelligence information instead">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="notes-${vehicleId}" class="form-label">Notes <small class="text-muted">(deprecated)</small></label>
                                <textarea class="form-control" id="notes-${vehicleId}" name="notes" rows="2"
                                         placeholder="Use intelligence information or operational instructions instead"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(vehicleRow);
}

function removeVehicleRow(vehicleId) {
    const vehicleRow = document.getElementById(`vehicle-${vehicleId}`);
    if (vehicleRow) {
        vehicleRow.remove();
    }
}

async function editHotlistGroup(id) {
    try {
        const response = await axios.get(`/api/hotlist-groups/${id}`);
        const group = response.data;
        
        currentHotlistGroupId = id;
        document.getElementById('modalTitle').textContent = 'Edit Hotlist Group';
        
        // Populate form
        document.getElementById('hotlistName').value = group.name;
        document.getElementById('category').value = group.category;
        document.getElementById('priority').value = group.priority;
        document.getElementById('createdBy').value = group.created_by;
        document.getElementById('description').value = group.description;
        document.getElementById('isActive').checked = group.is_active;
        
        if (group.expiry_date) {
            document.getElementById('expiryDate').value = new Date(group.expiry_date).toISOString().slice(0, 16);
        }
        
        // Clear existing vehicles
        document.getElementById('vehiclesContainer').innerHTML = '';
        vehicleCounter = 0;
        
        // Add vehicles from the group
        if (group.vehicles && group.vehicles.length > 0) {
            group.vehicles.forEach(vehicle => {
                addVehicleRow();
                const vehicleId = vehicleCounter - 1;
                document.getElementById(`licensePlate-${vehicleId}`).value = vehicle.license_plate;
                document.getElementById(`vehicleMake-${vehicleId}`).value = vehicle.vehicle_make || '';
                document.getElementById(`vehicleModel-${vehicleId}`).value = vehicle.vehicle_model || '';
                document.getElementById(`vehicleColor-${vehicleId}`).value = vehicle.vehicle_color || '';
                document.getElementById(`vehicleYear-${vehicleId}`).value = vehicle.vehicle_year || '';
                document.getElementById(`ownerName-${vehicleId}`).value = vehicle.owner_name || '';
                document.getElementById(`notes-${vehicleId}`).value = vehicle.notes || '';
            });
        } else {
            // Add one empty vehicle row if no vehicles exist
            addVehicleRow();
        }
        
        new bootstrap.Modal(document.getElementById('hotlistGroupModal')).show();
        
    } catch (error) {
        console.error('Error loading hotlist:', error);
        showAlert('Error loading hotlist details', 'danger');
    }
}

async function deleteHotlist(id) {
    if (!confirm('Are you sure you want to delete this hotlist entry?')) return;
    
    try {
        await axios.delete(`/api/hotlists/${id}`);
        showAlert('Hotlist deleted successfully', 'success');
        loadHotlists();
    } catch (error) {
        console.error('Error deleting hotlist:', error);
        showAlert('Error deleting hotlist', 'danger');
    }
}

async function saveHotlist() {
    const formData = {
        license_plate: document.getElementById('licensePlate').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        created_by: document.getElementById('createdBy').value,
        description: document.getElementById('description').value,
        vehicle_make: document.getElementById('vehicleMake').value || null,
        vehicle_model: document.getElementById('vehicleModel').value || null,
        vehicle_color: document.getElementById('vehicleColor').value || null,
        vehicle_year: document.getElementById('vehicleYear').value || null,
        owner_name: document.getElementById('ownerName').value || null,
        notes: document.getElementById('notes').value || null,
        is_active: document.getElementById('isActive').checked,
        expiry_date: document.getElementById('expiryDate').value || null
    };
    
    try {
        if (currentHotlistId) {
            await axios.put(`/api/hotlists/${currentHotlistId}`, formData);
            showAlert('Hotlist updated successfully', 'success');
        } else {
            await axios.post('/api/hotlists', formData);
            showAlert('Hotlist created successfully', 'success');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('hotlistModal')).hide();
        loadHotlists();
        
    } catch (error) {
        console.error('Error saving hotlist:', error);
        showAlert('Error saving hotlist', 'danger');
    }
}

async function saveHotlistGroup() {
    try {
        // Collect form data
        const formData = {
            name: document.getElementById('hotlistName').value,
            category: document.getElementById('category').value,
            priority: document.getElementById('priority').value,
            created_by: document.getElementById('createdBy').value,
            description: document.getElementById('description').value,
            is_active: document.getElementById('isActive').checked,
            expiry_date: document.getElementById('expiryDate').value || null,
            vehicles: []
        };
        
        // Collect vehicles data
        const vehicleCards = document.querySelectorAll('#vehiclesContainer .card');
        vehicleCards.forEach(card => {
            const vehicleId = card.id.split('-')[1];
            const licensePlate = document.getElementById(`licensePlate-${vehicleId}`).value;
            
            // Only add vehicle if license plate is provided
            if (licensePlate.trim()) {
                const vehicleData = {
                    // Basic vehicle identification
                    license_plate: licensePlate,
                    vehicle_make: document.getElementById(`vehicleMake-${vehicleId}`).value || null,
                    vehicle_model: document.getElementById(`vehicleModel-${vehicleId}`).value || null,
                    vehicle_color: document.getElementById(`vehicleColor-${vehicleId}`).value || null,
                    
                    // Extended ANPR-compliant vehicle details
                    vin_number: document.getElementById(`vinNumber-${vehicleId}`).value || null,
                    engine_number: document.getElementById(`engineNumber-${vehicleId}`).value || null,
                    engine_capacity: document.getElementById(`engineCapacity-${vehicleId}`).value ? parseInt(document.getElementById(`engineCapacity-${vehicleId}`).value) : null,
                    fuel_type: document.getElementById(`fuelType-${vehicleId}`).value || null,
                    body_type: document.getElementById(`bodyType-${vehicleId}`).value || null,
                    
                    // Registration information
                    date_of_first_registration: document.getElementById(`dateOfFirstRegistration-${vehicleId}`).value || null,
                    date_of_first_uk_registration: document.getElementById(`dateOfFirstUkRegistration-${vehicleId}`).value || null,
                    vehicle_manufactured_date: document.getElementById(`vehicleManufacturedDate-${vehicleId}`).value || null,
                    
                    // ANPR-specific operational fields
                    warning_markers: document.getElementById(`warningMarkers-${vehicleId}`).value || null,
                    nim_code: document.getElementById(`nimCode-${vehicleId}`).value || null,
                    force_area: document.getElementById(`forceArea-${vehicleId}`).value || null,
                    weed_date: document.getElementById(`weedDate-${vehicleId}`).value || null,
                    pnc_id: document.getElementById(`pncId-${vehicleId}`).value || null,
                    gpms_marking: document.getElementById(`gpmsMarking-${vehicleId}`).value || "Unclassified",
                    cad_information: document.getElementById(`cadInformation-${vehicleId}`).value || null,
                    
                    // Additional operational data
                    theft_marker: document.getElementById(`theftMarker-${vehicleId}`).checked || false,
                    scrap_marker: document.getElementById(`scrapMarker-${vehicleId}`).checked || false,
                    export_marker: document.getElementById(`exportMarker-${vehicleId}`).checked || false,
                    
                    // Extended description and intelligence
                    intelligence_information: document.getElementById(`intelligenceInformation-${vehicleId}`).value || null,
                    operational_instructions: document.getElementById(`operationalInstructions-${vehicleId}`).value || null,
                    vehicle_features: document.getElementById(`vehicleFeatures-${vehicleId}`).value || null,
                    
                    // Audit and tracking
                    source_reference: document.getElementById(`sourceReference-${vehicleId}`).value || null,
                    authorizing_officer: document.getElementById(`authorizingOfficer-${vehicleId}`).value || null,
                    review_date: document.getElementById(`reviewDate-${vehicleId}`).value || null,
                    
                    // Legacy fields for backward compatibility
                    vehicle_year: document.getElementById(`vehicleYear-${vehicleId}`).value ? parseInt(document.getElementById(`vehicleYear-${vehicleId}`).value) : null,
                    owner_name: document.getElementById(`ownerName-${vehicleId}`).value || null,
                    notes: document.getElementById(`notes-${vehicleId}`).value || null
                };
                
                formData.vehicles.push(vehicleData);
            }
        });
        
        // Validate that at least one vehicle is provided
        if (formData.vehicles.length === 0) {
            showAlert('Please add at least one vehicle with a license plate', 'danger');
            return;
        }
        
        let response;
        if (currentHotlistGroupId) {
            response = await axios.put(`/api/hotlist-groups/${currentHotlistGroupId}`, formData);
            showAlert('Hotlist group updated successfully', 'success');
        } else {
            response = await axios.post('/api/hotlist-groups', formData);
            showAlert('Hotlist group created successfully', 'success');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('hotlistGroupModal')).hide();
        loadHotlistGroups();
        resetHotlistGroupForm();
        
    } catch (error) {
        console.error('Error saving hotlist group:', error);
        showAlert('Error saving hotlist group: ' + (error.response?.data?.detail || error.message), 'danger');
    }
}

function resetForm() {
    currentHotlistId = null;
    document.getElementById('modalTitle').textContent = 'Add Hotlist Entry';
    document.getElementById('hotlistForm').reset();
    document.getElementById('priority').value = 'medium';
    document.getElementById('isActive').checked = true;
}

function resetHotlistGroupForm() {
    currentHotlistGroupId = null;
    document.getElementById('modalTitle').textContent = 'Add Hotlist Group';
    document.getElementById('hotlistGroupForm').reset();
    document.getElementById('priority').value = 'medium';
    document.getElementById('isActive').checked = true;
    document.getElementById('vehiclesContainer').innerHTML = '';
    vehicleCounter = 0;
    addVehicleRow();
}

function getCategoryColor(category) {
    const colors = {
        stolen: 'danger',
        wanted: 'warning',
        bolo: 'info',
        suspicious: 'secondary'
    };
    return colors[category] || 'primary';
}

function getPriorityColor(priority) {
    const colors = {
        low: 'success',
        medium: 'warning',
        high: 'danger',
        critical: 'dark'
    };
    return colors[priority] || 'primary';
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function showAlert(message, type) {
    // Simple alert for now - could be enhanced with toast notifications
    alert(message);
}
</script>
{% endblock %} 