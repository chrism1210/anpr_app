{% extends "base.html" %}

{% block title %}Hotlists - ANPR System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-list me-2"></i>
                Vehicle Hotlists
            </h1>
            <div>
                <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#csvUploadModal">
                    <i class="fas fa-upload me-2"></i>
                    Import CSV
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#hotlistGroupModal">
                    <i class="fas fa-plus me-2"></i>
                    Add Hotlist Group
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Search license plates, descriptions, or categories...">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="categoryFilter">
            <option value="">All Categories</option>
            <option value="stolen">Stolen</option>
            <option value="wanted">Wanted</option>
            <option value="bolo">BOLO</option>
            <option value="suspicious">Suspicious</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Hotlist Name</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Description</th>
                        <th>Vehicles</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="hotlistsTable">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- CSV Upload Modal -->
<div class="modal fade" id="csvUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Vehicles from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="csvHotlistSelect" class="form-label">Select Target Hotlist Group *</label>
                    <select class="form-select" id="csvHotlistSelect" required>
                        <option value="">Select a hotlist group...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="csvFile" class="form-label">Choose CSV File *</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                    <div class="form-text">
                        Supported formats: CSV files with or without headers. 
                        <a href="#" onclick="showCsvFormat()">View expected format</a>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="csvHasHeaders" checked>
                        <label class="form-check-label" for="csvHasHeaders">
                            File has headers (first row contains column names)
                        </label>
                    </div>
                </div>

                <div id="csvPreview" class="d-none">
                    <h6>Preview (first 5 rows):</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="csvPreviewTable">
                        </table>
                    </div>
                    
                    <div id="columnMapping" class="mt-3">
                        <h6>Column Mapping:</h6>
                        <div class="row" id="columnMappingContainer">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importCsvBtn" disabled>Import Vehicles</button>
            </div>
        </div>
    </div>
</div>

<!-- CSV Format Help Modal -->
<div class="modal fade" id="csvFormatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">CSV Format Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Supported Column Headers:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Required</th>
                                <th>Description</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>license_plate</td><td class="text-danger">Yes</td><td>Vehicle registration</td><td>AB12 CDE</td></tr>
                            <tr><td>vehicle_make</td><td>No</td><td>Vehicle manufacturer</td><td>Ford</td></tr>
                            <tr><td>vehicle_model</td><td>No</td><td>Vehicle model</td><td>Focus</td></tr>
                            <tr><td>vehicle_color</td><td>No</td><td>Vehicle color</td><td>Blue</td></tr>
                            <tr><td>vin_number</td><td>No</td><td>Vehicle identification number</td><td>1HGBH41JXMN109186</td></tr>
                            <tr><td>fuel_type</td><td>No</td><td>Fuel type</td><td>Petrol</td></tr>
                            <tr><td>body_type</td><td>No</td><td>Body type</td><td>Saloon</td></tr>
                            <tr><td>warning_markers</td><td>No</td><td>Warning markers</td><td>FIREARMS</td></tr>
                            <tr><td>intelligence_information</td><td>No</td><td>Intelligence notes</td><td>Seen at incident</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <h6 class="mt-3">Example CSV:</h6>
                <pre class="bg-light p-3"><code>license_plate,vehicle_make,vehicle_model,vehicle_color,warning_markers
AB12 CDE,Ford,Focus,Blue,FIREARMS
XY98 ZAB,BMW,X5,Black,
CD34 EFG,Toyota,Corolla,Red,VIOLENT</code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Hotlist Group Modal -->
<div class="modal fade" id="hotlistGroupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Hotlist Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="hotlistGroupForm">
                    <!-- Hotlist Group Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hotlistName" class="form-label">Hotlist Name *</label>
                                <input type="text" class="form-control" id="hotlistName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category *</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="stolen">Stolen</option>
                                    <option value="wanted">Wanted</option>
                                    <option value="bolo">BOLO</option>
                                    <option value="suspicious">Suspicious</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createdBy" class="form-label">Created By *</label>
                                <input type="text" class="form-control" id="createdBy" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    
                    <hr>
                    
                    <!-- Streamlined Vehicle Grid Entry -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Vehicles in this Hotlist</h6>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="toggleAdvancedFields">
                                <i class="fas fa-cog me-1"></i>
                                Advanced Fields
                            </button>
                            <button type="button" class="btn btn-sm btn-success" id="addVehicleBtn">
                                <i class="fas fa-plus me-1"></i>
                                Add Vehicle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vehicle Grid Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered" id="vehicleGrid">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 120px;">License Plate *</th>
                                    <th style="width: 100px;">Make</th>
                                    <th style="width: 100px;">Model</th>
                                    <th style="width: 80px;">Color</th>
                                    <th style="width: 100px;">Body Type</th>
                                    <th style="width: 80px;">Fuel Type</th>
                                    <!-- Advanced fields (initially hidden) -->
                                    <th class="advanced-field d-none" style="width: 120px;">VIN</th>
                                    <th class="advanced-field d-none" style="width: 100px;">Warning Markers</th>
                                    <th class="advanced-field d-none" style="width: 150px;">Intelligence Info</th>
                                    <th class="advanced-field d-none" style="width: 80px;">Force Area</th>
                                    <th style="width: 50px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicleGridBody">
                                <!-- Vehicle rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expiryDate" class="form-label">Expiry Date</label>
                                <input type="datetime-local" class="form-control" id="expiryDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 form-check" style="margin-top: 2rem;">
                                <input type="checkbox" class="form-check-input" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn">Save Hotlist Group</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentHotlistGroupId = null;
let vehicleCounter = 0;
let showAdvancedFields = false;

document.addEventListener('DOMContentLoaded', function() {
    loadHotlistGroups();
    loadHotlistGroupsForCsv();
    
    // Search functionality
    document.getElementById('searchBtn').addEventListener('click', loadHotlistGroups);
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadHotlistGroups();
        }
    });
    
    // Filter functionality
    document.getElementById('categoryFilter').addEventListener('change', loadHotlistGroups);
    document.getElementById('statusFilter').addEventListener('change', loadHotlistGroups);
    
    // Form submission
    document.getElementById('saveBtn').addEventListener('click', saveHotlistGroup);
    
    // Add vehicle button
    document.getElementById('addVehicleBtn').addEventListener('click', addVehicleRow);
    
    // Toggle advanced fields
    document.getElementById('toggleAdvancedFields').addEventListener('click', toggleAdvancedFields);
    
    // CSV functionality
    document.getElementById('csvFile').addEventListener('change', handleCsvFileSelect);
    document.getElementById('importCsvBtn').addEventListener('click', importCsvData);
    
    // Reset form when modal closes
    document.getElementById('hotlistGroupModal').addEventListener('hidden.bs.modal', function () {
        resetHotlistGroupForm();
    });
    
    // Add initial vehicle row
    addVehicleRow();
});

async function loadHotlistGroups() {
    try {
        const search = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = '/api/hotlist-groups';
        const params = new URLSearchParams();
        
        if (search) params.append('search', search);
        if (params.toString()) url += '?' + params.toString();
        
        const response = await axios.get(url);
        let hotlistGroups = response.data;
        
        // Filter by category and status on frontend
        if (category) {
            hotlistGroups = hotlistGroups.filter(h => h.category === category);
        }
        if (status) {
            hotlistGroups = hotlistGroups.filter(h => status === 'active' ? h.is_active : !h.is_active);
        }
        
        const tableBody = document.getElementById('hotlistsTable');
        
        if (hotlistGroups.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hotlist groups found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = hotlistGroups.map(group => `
            <tr>
                <td><strong>${group.name}</strong></td>
                <td>
                    <span class="badge bg-${getCategoryColor(group.category)}">${group.category}</span>
                </td>
                <td>
                    <span class="badge bg-${getPriorityColor(group.priority)}">${group.priority}</span>
                </td>
                <td>${group.description}</td>
                <td>
                    <div class="d-flex flex-wrap gap-1">
                        ${group.vehicles.map(vehicle => `
                            <span class="badge bg-primary" title="${vehicle.vehicle_make || ''} ${vehicle.vehicle_model || ''} ${vehicle.vehicle_color || ''}">
                                ${vehicle.license_plate}
                            </span>
                        `).join('')}
                    </div>
                </td>
                <td>${formatDate(group.created_at)}</td>
                <td>
                    <span class="badge bg-${group.is_active ? 'success' : 'secondary'}">
                        ${group.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editHotlistGroup(${group.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteHotlistGroup(${group.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading hotlists:', error);
        showAlert('Error loading hotlists', 'danger');
    }
}

// Load hotlist groups for CSV upload dropdown
async function loadHotlistGroupsForCsv() {
    try {
        const response = await axios.get('/api/hotlist-groups');
        const select = document.getElementById('csvHotlistSelect');
        
        select.innerHTML = '<option value="">Select a hotlist group...</option>';
        response.data.forEach(group => {
            select.innerHTML += `<option value="${group.id}">${group.name} (${group.category})</option>`;
        });
    } catch (error) {
        console.error('Error loading hotlist groups for CSV:', error);
    }
}

// Toggle advanced fields visibility
function toggleAdvancedFields() {
    showAdvancedFields = !showAdvancedFields;
    const advancedFields = document.querySelectorAll('.advanced-field');
    const btn = document.getElementById('toggleAdvancedFields');
    
    advancedFields.forEach(field => {
        if (showAdvancedFields) {
            field.classList.remove('d-none');
        } else {
            field.classList.add('d-none');
        }
    });
    
    btn.innerHTML = showAdvancedFields 
        ? '<i class="fas fa-cog me-1"></i>Hide Advanced' 
        : '<i class="fas fa-cog me-1"></i>Advanced Fields';
}

// Add vehicle row to the grid
function addVehicleRow() {
    const tbody = document.getElementById('vehicleGridBody');
    const vehicleId = vehicleCounter++;
    
    const row = document.createElement('tr');
    row.id = `vehicle-row-${vehicleId}`;
    row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" id="licensePlate-${vehicleId}" required placeholder="AB12 CDE" tabindex="${vehicleId * 10 + 1}"></td>
        <td><input type="text" class="form-control form-control-sm" id="vehicleMake-${vehicleId}" placeholder="Ford" tabindex="${vehicleId * 10 + 2}"></td>
        <td><input type="text" class="form-control form-control-sm" id="vehicleModel-${vehicleId}" placeholder="Focus" tabindex="${vehicleId * 10 + 3}"></td>
        <td><input type="text" class="form-control form-control-sm" id="vehicleColor-${vehicleId}" placeholder="Blue" tabindex="${vehicleId * 10 + 4}"></td>
        <td>
            <select class="form-select form-select-sm" id="bodyType-${vehicleId}" tabindex="${vehicleId * 10 + 5}">
                <option value="">Select</option>
                <option value="Saloon">Saloon</option>
                <option value="Hatchback">Hatchback</option>
                <option value="Estate">Estate</option>
                <option value="SUV">SUV</option>
                <option value="Van">Van</option>
                <option value="Motorcycle">Motorcycle</option>
            </select>
        </td>
        <td>
            <select class="form-select form-select-sm" id="fuelType-${vehicleId}" tabindex="${vehicleId * 10 + 6}">
                <option value="">Select</option>
                <option value="Petrol">Petrol</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
                <option value="Hybrid">Hybrid</option>
            </select>
        </td>
        <!-- Advanced fields -->
        <td class="advanced-field d-none"><input type="text" class="form-control form-control-sm" id="vinNumber-${vehicleId}" placeholder="VIN" tabindex="${vehicleId * 10 + 7}"></td>
        <td class="advanced-field d-none"><input type="text" class="form-control form-control-sm" id="warningMarkers-${vehicleId}" placeholder="FIREARMS" tabindex="${vehicleId * 10 + 8}"></td>
        <td class="advanced-field d-none"><input type="text" class="form-control form-control-sm" id="intelligenceInformation-${vehicleId}" placeholder="Intelligence notes" tabindex="${vehicleId * 10 + 9}"></td>
        <td class="advanced-field d-none"><input type="text" class="form-control form-control-sm" id="forceArea-${vehicleId}" placeholder="Force" tabindex="${vehicleId * 10 + 10}"></td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVehicleRow(${vehicleId})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    // Focus on the license plate field
    document.getElementById(`licensePlate-${vehicleId}`).focus();
}

// Remove vehicle row
function removeVehicleRow(vehicleId) {
    const row = document.getElementById(`vehicle-row-${vehicleId}`);
    if (row) {
        row.remove();
    }
}

// CSV Upload functionality
function handleCsvFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n').filter(line => line.trim());
        
        if (lines.length === 0) {
            showAlert('CSV file is empty', 'danger');
            return;
        }
        
        displayCsvPreview(lines);
    };
    reader.readAsText(file);
}

function displayCsvPreview(lines) {
    const hasHeaders = document.getElementById('csvHasHeaders').checked;
    const previewDiv = document.getElementById('csvPreview');
    const table = document.getElementById('csvPreviewTable');
    const mappingContainer = document.getElementById('columnMappingContainer');
    
    previewDiv.classList.remove('d-none');
    
    // Parse CSV data
    const data = lines.map(line => line.split(',').map(cell => cell.trim().replace(/^"(.*)"$/, '$1')));
    const headers = hasHeaders ? data[0] : data[0].map((_, i) => `Column ${i + 1}`);
    const rows = hasHeaders ? data.slice(1, 6) : data.slice(0, 5); // Show first 5 data rows
    
    // Display preview table
    table.innerHTML = `
        <thead>
            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
        </thead>
        <tbody>
            ${rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
        </tbody>
    `;
    
    // Create column mapping
    const fieldMappings = [
        { key: 'license_plate', label: 'License Plate (Required)', required: true },
        { key: 'vehicle_make', label: 'Vehicle Make' },
        { key: 'vehicle_model', label: 'Vehicle Model' },
        { key: 'vehicle_color', label: 'Vehicle Color' },
        { key: 'vin_number', label: 'VIN Number' },
        { key: 'fuel_type', label: 'Fuel Type' },
        { key: 'body_type', label: 'Body Type' },
        { key: 'warning_markers', label: 'Warning Markers' },
        { key: 'intelligence_information', label: 'Intelligence Information' },
        { key: 'force_area', label: 'Force Area' }
    ];
    
    mappingContainer.innerHTML = fieldMappings.map(field => `
        <div class="col-md-6 mb-2">
            <label class="form-label small">${field.label}:</label>
            <select class="form-select form-select-sm" id="mapping-${field.key}">
                <option value="">-- Skip --</option>
                ${headers.map((h, i) => {
                    const selected = h.toLowerCase().includes(field.key.replace('_', '')) || 
                                   h.toLowerCase() === field.key ? 'selected' : '';
                    return `<option value="${i}" ${selected}>${h}</option>`;
                }).join('')}
            </select>
        </div>
    `).join('');
    
    document.getElementById('importCsvBtn').disabled = false;
}

async function importCsvData() {
    const hotlistGroupId = document.getElementById('csvHotlistSelect').value;
    const fileInput = document.getElementById('csvFile');
    const hasHeaders = document.getElementById('csvHasHeaders').checked;
    
    if (!hotlistGroupId || !fileInput.files[0]) {
        showAlert('Please select a hotlist group and CSV file', 'danger');
        return;
    }
    
    try {
        const file = fileInput.files[0];
        const csv = await file.text();
        const lines = csv.split('\n').filter(line => line.trim());
        const data = lines.map(line => line.split(',').map(cell => cell.trim().replace(/^"(.*)"$/, '$1')));
        const dataRows = hasHeaders ? data.slice(1) : data;
        
        // Get column mappings
        const mappings = {};
        document.querySelectorAll('[id^="mapping-"]').forEach(select => {
            const fieldKey = select.id.replace('mapping-', '');
            const columnIndex = select.value;
            if (columnIndex !== '') {
                mappings[fieldKey] = parseInt(columnIndex);
            }
        });
        
        // Validate required fields
        if (mappings.license_plate === undefined) {
            showAlert('License Plate mapping is required', 'danger');
            return;
        }
        
        // Process vehicles
        const vehicles = dataRows.map(row => {
            const vehicle = {};
            Object.keys(mappings).forEach(fieldKey => {
                const columnIndex = mappings[fieldKey];
                if (row[columnIndex]) {
                    vehicle[fieldKey] = row[columnIndex];
                }
            });
            return vehicle;
        }).filter(v => v.license_plate); // Only include rows with license plates
        
        if (vehicles.length === 0) {
            showAlert('No valid vehicles found in CSV', 'danger');
            return;
        }
        
        // Import vehicles
        document.getElementById('importCsvBtn').disabled = true;
        document.getElementById('importCsvBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Importing...';
        
        for (const vehicle of vehicles) {
            vehicle.hotlist_group_id = parseInt(hotlistGroupId);
            await axios.post('/api/vehicles', vehicle);
        }
        
        showAlert(`Successfully imported ${vehicles.length} vehicles`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('csvUploadModal')).hide();
        loadHotlistGroups();
        
    } catch (error) {
        console.error('Error importing CSV:', error);
        showAlert('Error importing CSV: ' + (error.response?.data?.detail || error.message), 'danger');
    } finally {
        document.getElementById('importCsvBtn').disabled = false;
        document.getElementById('importCsvBtn').innerHTML = 'Import Vehicles';
    }
}

function showCsvFormat() {
    bootstrap.Modal.getInstance(document.getElementById('csvUploadModal')).hide();
    new bootstrap.Modal(document.getElementById('csvFormatModal')).show();
}

async function saveHotlistGroup() {
    const form = document.getElementById('hotlistGroupForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    try {
        // Collect basic hotlist group data
        const hotlistData = {
            name: document.getElementById('hotlistName').value,
            description: document.getElementById('description').value,
            category: document.getElementById('category').value,
            priority: document.getElementById('priority').value,
            created_by: document.getElementById('createdBy').value,
            is_active: document.getElementById('isActive').checked,
            expiry_date: document.getElementById('expiryDate').value || null
        };
        
        // Collect vehicles from grid
        const vehicles = [];
        const vehicleRows = document.querySelectorAll('#vehicleGridBody tr');
        
        vehicleRows.forEach((row, index) => {
            const licensePlate = row.querySelector(`input[id^="licensePlate-"]`)?.value;
            if (licensePlate) {
                const vehicleId = row.id.split('-')[2];
                const vehicle = {
                    license_plate: licensePlate,
                    vehicle_make: document.getElementById(`vehicleMake-${vehicleId}`)?.value || null,
                    vehicle_model: document.getElementById(`vehicleModel-${vehicleId}`)?.value || null,
                    vehicle_color: document.getElementById(`vehicleColor-${vehicleId}`)?.value || null,
                    body_type: document.getElementById(`bodyType-${vehicleId}`)?.value || null,
                    fuel_type: document.getElementById(`fuelType-${vehicleId}`)?.value || null,
                    vin_number: document.getElementById(`vinNumber-${vehicleId}`)?.value || null,
                    warning_markers: document.getElementById(`warningMarkers-${vehicleId}`)?.value || null,
                    intelligence_information: document.getElementById(`intelligenceInformation-${vehicleId}`)?.value || null,
                    force_area: document.getElementById(`forceArea-${vehicleId}`)?.value || null
                };
                vehicles.push(vehicle);
            }
        });
        
        hotlistData.vehicles = vehicles;
        
        let response;
        if (currentHotlistGroupId) {
            response = await axios.put(`/api/hotlist-groups/${currentHotlistGroupId}`, hotlistData);
        } else {
            response = await axios.post('/api/hotlist-groups', hotlistData);
        }
        
        showAlert('Hotlist group saved successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('hotlistGroupModal')).hide();
        loadHotlistGroups();
        
    } catch (error) {
        console.error('Error saving hotlist group:', error);
        showAlert('Error saving hotlist group: ' + (error.response?.data?.detail || error.message), 'danger');
    }
}

async function editHotlistGroup(id) {
    try {
        const response = await axios.get(`/api/hotlist-groups/${id}`);
        const group = response.data;
        
        currentHotlistGroupId = id;
        document.getElementById('modalTitle').textContent = 'Edit Hotlist Group';
        
        // Populate basic fields
        document.getElementById('hotlistName').value = group.name;
        document.getElementById('description').value = group.description;
        document.getElementById('category').value = group.category;
        document.getElementById('priority').value = group.priority;
        document.getElementById('createdBy').value = group.created_by;
        document.getElementById('isActive').checked = group.is_active;
        
        if (group.expiry_date) {
            const date = new Date(group.expiry_date);
            document.getElementById('expiryDate').value = date.toISOString().slice(0, 16);
        }
        
        // Clear existing vehicle rows
        document.getElementById('vehicleGridBody').innerHTML = '';
        vehicleCounter = 0;
        
        // Add vehicle rows
        if (group.vehicles && group.vehicles.length > 0) {
            group.vehicles.forEach(vehicle => {
                addVehicleRow();
                const vehicleId = vehicleCounter - 1;
                
                // Populate vehicle data
                document.getElementById(`licensePlate-${vehicleId}`).value = vehicle.license_plate || '';
                document.getElementById(`vehicleMake-${vehicleId}`).value = vehicle.vehicle_make || '';
                document.getElementById(`vehicleModel-${vehicleId}`).value = vehicle.vehicle_model || '';
                document.getElementById(`vehicleColor-${vehicleId}`).value = vehicle.vehicle_color || '';
                document.getElementById(`bodyType-${vehicleId}`).value = vehicle.body_type || '';
                document.getElementById(`fuelType-${vehicleId}`).value = vehicle.fuel_type || '';
                
                if (showAdvancedFields) {
                    document.getElementById(`vinNumber-${vehicleId}`).value = vehicle.vin_number || '';
                    document.getElementById(`warningMarkers-${vehicleId}`).value = vehicle.warning_markers || '';
                    document.getElementById(`intelligenceInformation-${vehicleId}`).value = vehicle.intelligence_information || '';
                    document.getElementById(`forceArea-${vehicleId}`).value = vehicle.force_area || '';
                }
            });
        } else {
            addVehicleRow();
        }
        
        new bootstrap.Modal(document.getElementById('hotlistGroupModal')).show();
        
    } catch (error) {
        console.error('Error loading hotlist group:', error);
        showAlert('Error loading hotlist group', 'danger');
    }
}

async function deleteHotlistGroup(id) {
    if (!confirm('Are you sure you want to delete this hotlist group? This action cannot be undone.')) {
        return;
    }
    
    try {
        await axios.delete(`/api/hotlist-groups/${id}`);
        showAlert('Hotlist group deleted successfully', 'success');
        loadHotlistGroups();
    } catch (error) {
        console.error('Error deleting hotlist group:', error);
        showAlert('Error deleting hotlist group', 'danger');
    }
}

function resetHotlistGroupForm() {
    currentHotlistGroupId = null;
    document.getElementById('modalTitle').textContent = 'Add Hotlist Group';
    document.getElementById('hotlistGroupForm').reset();
    document.getElementById('vehicleGridBody').innerHTML = '';
    vehicleCounter = 0;
    addVehicleRow();
    
    // Reset advanced fields
    showAdvancedFields = false;
    document.querySelectorAll('.advanced-field').forEach(field => field.classList.add('d-none'));
    document.getElementById('toggleAdvancedFields').innerHTML = '<i class="fas fa-cog me-1"></i>Advanced Fields';
}

// Helper functions
function getCategoryColor(category) {
    const colors = {
        'stolen': 'danger',
        'wanted': 'warning',
        'bolo': 'info',
        'suspicious': 'secondary'
    };
    return colors[category] || 'primary';
}

function getPriorityColor(priority) {
    const colors = {
        'low': 'secondary',
        'medium': 'primary',
        'high': 'warning',
        'critical': 'danger'
    };
    return colors[priority] || 'primary';
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showAlert(message, type = 'info') {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 