{% extends "base.html" %}

{% block title %}Hotlists - ANPR System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-list me-2"></i>
                Vehicle Hotlists
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#hotlistGroupModal">
                <i class="fas fa-plus me-2"></i>
                Add Hotlist Group
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Search license plates, descriptions, or categories...">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="categoryFilter">
            <option value="">All Categories</option>
            <option value="stolen">Stolen</option>
            <option value="wanted">Wanted</option>
            <option value="bolo">BOLO</option>
            <option value="suspicious">Suspicious</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Hotlist Name</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Description</th>
                        <th>Vehicles</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="hotlistsTable">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Hotlist Group Modal -->
<div class="modal fade" id="hotlistGroupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Hotlist Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="hotlistGroupForm">
                    <!-- Hotlist Group Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hotlistName" class="form-label">Hotlist Name *</label>
                                <input type="text" class="form-control" id="hotlistName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category *</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="stolen">Stolen</option>
                                    <option value="wanted">Wanted</option>
                                    <option value="bolo">BOLO</option>
                                    <option value="suspicious">Suspicious</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createdBy" class="form-label">Created By *</label>
                                <input type="text" class="form-control" id="createdBy" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    

                    
                    <hr>
                    
                    <!-- Vehicles Section -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Vehicles in this Hotlist</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addVehicleBtn">
                            <i class="fas fa-plus me-1"></i>
                            Add Vehicle
                        </button>
                    </div>
                    
                    <div id="vehiclesContainer">
                        <!-- Vehicle entries will be added here -->
                    </div>
                    

                    

                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expiryDate" class="form-label">Expiry Date</label>
                                <input type="datetime-local" class="form-control" id="expiryDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 form-check" style="margin-top: 2rem;">
                                <input type="checkbox" class="form-check-input" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn">Save Hotlist Group</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentHotlistGroupId = null;
let vehicleCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadHotlistGroups();
    
    // Search functionality
    document.getElementById('searchBtn').addEventListener('click', loadHotlistGroups);
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadHotlistGroups();
        }
    });
    
    // Filter functionality
    document.getElementById('categoryFilter').addEventListener('change', loadHotlistGroups);
    document.getElementById('statusFilter').addEventListener('change', loadHotlistGroups);
    
    // Form submission
    document.getElementById('saveBtn').addEventListener('click', saveHotlistGroup);
    
    // Add vehicle button
    document.getElementById('addVehicleBtn').addEventListener('click', addVehicleRow);
    
    // Reset form when modal closes
    document.getElementById('hotlistGroupModal').addEventListener('hidden.bs.modal', function () {
        resetHotlistGroupForm();
    });
    
    // Add initial vehicle row
    addVehicleRow();
});

async function loadHotlistGroups() {
    try {
        const search = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = '/api/hotlist-groups';
        const params = new URLSearchParams();
        
        if (search) params.append('search', search);
        if (params.toString()) url += '?' + params.toString();
        
        const response = await axios.get(url);
        let hotlistGroups = response.data;
        
        // Filter by category and status on frontend
        if (category) {
            hotlistGroups = hotlistGroups.filter(h => h.category === category);
        }
        if (status) {
            hotlistGroups = hotlistGroups.filter(h => status === 'active' ? h.is_active : !h.is_active);
        }
        
        const tableBody = document.getElementById('hotlistsTable');
        
        if (hotlistGroups.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hotlist groups found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = hotlistGroups.map(group => `
            <tr>
                <td><strong>${group.name}</strong></td>
                <td>
                    <span class="badge bg-${getCategoryColor(group.category)}">${group.category}</span>
                </td>
                <td>
                    <span class="badge bg-${getPriorityColor(group.priority)}">${group.priority}</span>
                </td>
                <td>${group.description}</td>
                <td>
                    <div class="d-flex flex-wrap gap-1">
                        ${group.vehicles.map(vehicle => `
                            <span class="badge bg-primary" title="${vehicle.vehicle_make || ''} ${vehicle.vehicle_model || ''} ${vehicle.vehicle_color || ''}">
                                ${vehicle.license_plate}
                            </span>
                        `).join('')}
                    </div>
                </td>
                <td>${formatDate(group.created_at)}</td>
                <td>
                    <span class="badge bg-${group.is_active ? 'success' : 'secondary'}">
                        ${group.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editHotlistGroup(${group.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteHotlistGroup(${group.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading hotlists:', error);
        showAlert('Error loading hotlists', 'danger');
    }
}

// Add vehicle row to the form
function addVehicleRow() {
    const container = document.getElementById('vehiclesContainer');
    const vehicleId = vehicleCounter++;
    
    const vehicleRow = document.createElement('div');
    vehicleRow.className = 'card mb-3';
    vehicleRow.id = `vehicle-${vehicleId}`;
    vehicleRow.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-title mb-0">Vehicle ${vehicleId + 1}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVehicleRow(${vehicleId})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="licensePlate-${vehicleId}" class="form-label">License Plate *</label>
                        <input type="text" class="form-control" id="licensePlate-${vehicleId}" name="licensePlate" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="vehicleMake-${vehicleId}" class="form-label">Make</label>
                        <input type="text" class="form-control" id="vehicleMake-${vehicleId}" name="vehicleMake">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="vehicleModel-${vehicleId}" class="form-label">Model</label>
                        <input type="text" class="form-control" id="vehicleModel-${vehicleId}" name="vehicleModel">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="vehicleColor-${vehicleId}" class="form-label">Color</label>
                        <input type="text" class="form-control" id="vehicleColor-${vehicleId}" name="vehicleColor">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="vehicleYear-${vehicleId}" class="form-label">Year</label>
                        <input type="number" class="form-control" id="vehicleYear-${vehicleId}" name="vehicleYear" min="1900" max="2030">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="ownerName-${vehicleId}" class="form-label">Owner Name</label>
                        <input type="text" class="form-control" id="ownerName-${vehicleId}" name="ownerName">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="mb-3">
                        <label for="notes-${vehicleId}" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes-${vehicleId}" name="notes" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(vehicleRow);
}

function removeVehicleRow(vehicleId) {
    const vehicleRow = document.getElementById(`vehicle-${vehicleId}`);
    if (vehicleRow) {
        vehicleRow.remove();
    }
}

async function editHotlistGroup(id) {
    try {
        const response = await axios.get(`/api/hotlist-groups/${id}`);
        const group = response.data;
        
        currentHotlistGroupId = id;
        document.getElementById('modalTitle').textContent = 'Edit Hotlist Group';
        
        // Populate form
        document.getElementById('hotlistName').value = group.name;
        document.getElementById('category').value = group.category;
        document.getElementById('priority').value = group.priority;
        document.getElementById('createdBy').value = group.created_by;
        document.getElementById('description').value = group.description;
        document.getElementById('isActive').checked = group.is_active;
        
        if (group.expiry_date) {
            document.getElementById('expiryDate').value = new Date(group.expiry_date).toISOString().slice(0, 16);
        }
        
        // Clear existing vehicles
        document.getElementById('vehiclesContainer').innerHTML = '';
        vehicleCounter = 0;
        
        // Add vehicles from the group
        if (group.vehicles && group.vehicles.length > 0) {
            group.vehicles.forEach(vehicle => {
                addVehicleRow();
                const vehicleId = vehicleCounter - 1;
                document.getElementById(`licensePlate-${vehicleId}`).value = vehicle.license_plate;
                document.getElementById(`vehicleMake-${vehicleId}`).value = vehicle.vehicle_make || '';
                document.getElementById(`vehicleModel-${vehicleId}`).value = vehicle.vehicle_model || '';
                document.getElementById(`vehicleColor-${vehicleId}`).value = vehicle.vehicle_color || '';
                document.getElementById(`vehicleYear-${vehicleId}`).value = vehicle.vehicle_year || '';
                document.getElementById(`ownerName-${vehicleId}`).value = vehicle.owner_name || '';
                document.getElementById(`notes-${vehicleId}`).value = vehicle.notes || '';
            });
        } else {
            // Add one empty vehicle row if no vehicles exist
            addVehicleRow();
        }
        
        new bootstrap.Modal(document.getElementById('hotlistGroupModal')).show();
        
    } catch (error) {
        console.error('Error loading hotlist:', error);
        showAlert('Error loading hotlist details', 'danger');
    }
}

async function deleteHotlist(id) {
    if (!confirm('Are you sure you want to delete this hotlist entry?')) return;
    
    try {
        await axios.delete(`/api/hotlists/${id}`);
        showAlert('Hotlist deleted successfully', 'success');
        loadHotlists();
    } catch (error) {
        console.error('Error deleting hotlist:', error);
        showAlert('Error deleting hotlist', 'danger');
    }
}

async function saveHotlist() {
    const formData = {
        license_plate: document.getElementById('licensePlate').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        created_by: document.getElementById('createdBy').value,
        description: document.getElementById('description').value,
        vehicle_make: document.getElementById('vehicleMake').value || null,
        vehicle_model: document.getElementById('vehicleModel').value || null,
        vehicle_color: document.getElementById('vehicleColor').value || null,
        vehicle_year: document.getElementById('vehicleYear').value || null,
        owner_name: document.getElementById('ownerName').value || null,
        notes: document.getElementById('notes').value || null,
        is_active: document.getElementById('isActive').checked,
        expiry_date: document.getElementById('expiryDate').value || null
    };
    
    try {
        if (currentHotlistId) {
            await axios.put(`/api/hotlists/${currentHotlistId}`, formData);
            showAlert('Hotlist updated successfully', 'success');
        } else {
            await axios.post('/api/hotlists', formData);
            showAlert('Hotlist created successfully', 'success');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('hotlistModal')).hide();
        loadHotlists();
        
    } catch (error) {
        console.error('Error saving hotlist:', error);
        showAlert('Error saving hotlist', 'danger');
    }
}

async function saveHotlistGroup() {
    try {
        // Collect form data
        const formData = {
            name: document.getElementById('hotlistName').value,
            category: document.getElementById('category').value,
            priority: document.getElementById('priority').value,
            created_by: document.getElementById('createdBy').value,
            description: document.getElementById('description').value,
            is_active: document.getElementById('isActive').checked,
            expiry_date: document.getElementById('expiryDate').value || null,
            vehicles: []
        };
        
        // Collect vehicles data
        const vehicleCards = document.querySelectorAll('#vehiclesContainer .card');
        vehicleCards.forEach(card => {
            const vehicleId = card.id.split('-')[1];
            const licensePlate = document.getElementById(`licensePlate-${vehicleId}`).value;
            
            // Only add vehicle if license plate is provided
            if (licensePlate.trim()) {
                formData.vehicles.push({
                    license_plate: licensePlate,
                    vehicle_make: document.getElementById(`vehicleMake-${vehicleId}`).value || null,
                    vehicle_model: document.getElementById(`vehicleModel-${vehicleId}`).value || null,
                    vehicle_color: document.getElementById(`vehicleColor-${vehicleId}`).value || null,
                    vehicle_year: document.getElementById(`vehicleYear-${vehicleId}`).value || null,
                    owner_name: document.getElementById(`ownerName-${vehicleId}`).value || null,
                    notes: document.getElementById(`notes-${vehicleId}`).value || null
                });
            }
        });
        
        // Validate that at least one vehicle is provided
        if (formData.vehicles.length === 0) {
            showAlert('Please add at least one vehicle with a license plate', 'danger');
            return;
        }
        
        let response;
        if (currentHotlistGroupId) {
            response = await axios.put(`/api/hotlist-groups/${currentHotlistGroupId}`, formData);
            showAlert('Hotlist group updated successfully', 'success');
        } else {
            response = await axios.post('/api/hotlist-groups', formData);
            showAlert('Hotlist group created successfully', 'success');
        }
        
        bootstrap.Modal.getInstance(document.getElementById('hotlistGroupModal')).hide();
        loadHotlistGroups();
        resetHotlistGroupForm();
        
    } catch (error) {
        console.error('Error saving hotlist group:', error);
        showAlert('Error saving hotlist group: ' + (error.response?.data?.detail || error.message), 'danger');
    }
}

function resetForm() {
    currentHotlistId = null;
    document.getElementById('modalTitle').textContent = 'Add Hotlist Entry';
    document.getElementById('hotlistForm').reset();
    document.getElementById('priority').value = 'medium';
    document.getElementById('isActive').checked = true;
}

function resetHotlistGroupForm() {
    currentHotlistGroupId = null;
    document.getElementById('modalTitle').textContent = 'Add Hotlist Group';
    document.getElementById('hotlistGroupForm').reset();
    document.getElementById('priority').value = 'medium';
    document.getElementById('isActive').checked = true;
    document.getElementById('vehiclesContainer').innerHTML = '';
    vehicleCounter = 0;
    addVehicleRow();
}

function getCategoryColor(category) {
    const colors = {
        stolen: 'danger',
        wanted: 'warning',
        bolo: 'info',
        suspicious: 'secondary'
    };
    return colors[category] || 'primary';
}

function getPriorityColor(priority) {
    const colors = {
        low: 'success',
        medium: 'warning',
        high: 'danger',
        critical: 'dark'
    };
    return colors[priority] || 'primary';
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function showAlert(message, type) {
    // Simple alert for now - could be enhanced with toast notifications
    alert(message);
}
</script>
{% endblock %} 